AWSTemplateFormatVersion: 2010-09-09
Description: RDS Storage Encrypted
Parameters:
  ImageIdparam:
    Default: "ami-0282cf077acf11412"
    Description: ImageId parameter (eg ami-0282cf077acf11412)
    Type: String
  myVPC:
    Default: "vpc-0da8848c971eb9aa3"
    Type: String
  SourceDBInstanceIdentifier:
    Default: "csye6225-spring2019"
    Type: String
  DBInstanceType: 
    Default: "db.m4.xlarge"
    Type: String
  EC2Subnet:
    Default: "subnet-054379b3f39cce09e"
    Description: subnet parameter (eg subnet-08edd817a280766ff)
    Type: String  

Resources:
  MyRDSsubnetGroup: 
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: RDS subnet group
      SubnetIds: 
        - "subnet-03ed3f8b9c7f27415"
        - "subnet-054379b3f39cce09e"
      Tags:
      - Key: Name
        Value:
          Fn::Join:
            - '-'
            - [{Ref: 'AWS::StackName'}, 'csye6225', 'rds_subnet']        
  RDSSecurityGroup: 
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow http, SSH and SSL to client host
      VpcId:
        Ref: myVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 3306
        ToPort: 3306
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value:
          Fn::Join:
            - '-'
            - [{Ref: 'AWS::StackName'}, 'csye6225', 'rds_sg']  

  MyRDSInstance: 
    Type: AWS::RDS::DBInstance
    Properties: 
      AllocatedStorage: "100"
      DBInstanceClass: 
        Ref: "DBInstanceType"
      DBInstanceIdentifier: "SourceDBInstanceIdentifier"  
      Engine: "mysql"
      EngineVersion: "5.6.34"
      MultiAZ : false
      MasterUsername: "csye6225master"
        #Ref: "DBUser"
      MasterUserPassword: "csye6225password"
        #Ref: "DBPassword"
      PubliclyAccessible: true
      DBName: "csye6225"
      DBSubnetGroupName: 
        Ref: "MyRDSsubnetGroup"
      DBSecurityGroups: 
        Ref: "MyDBSecurityGroup"
      Tags:
      - Key: Name
        Value:
          Fn::Join:
            - '-'
            - [{Ref: 'AWS::StackName'}, 'csye6225', 'rds']
          
  MyDBSecurityGroup: 
    Type: AWS::RDS::DBSecurityGroup
    Properties: 
      GroupDescription: "Ingress for Amazon EC2 security group"
      EC2VpcId: 
        Ref: "myVPC"
      DBSecurityGroupIngress: 
      - EC2SecurityGroupName: 
          Ref: "RDSSecurityGroup"
      Tags:
      - Key: Name
        Value:
          Fn::Join:
            - '-'
            - [{Ref: 'AWS::StackName'}, 'csye6225', 'db_sg']      










 
 